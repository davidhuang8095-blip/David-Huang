<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chosen Palette: Warm Neutrals with clear accents -->
    <!-- Application Structure Plan: A 2-section, scrollable SPA, fixed to the Dividend path. 1. Header/Nav. 2. Scenario Inputs (Sliders for Equity & Dividend). 3. Fixed Dividend Cash Flow Simulation. This structure allows users to modify core tax assumptions (equity/dividend amount) and instantly see the financial impact of the worst-case (dividend) tax path. -->
    <!-- Visualization & Content Choices: 
        - Corporate Tax (Section 2): Goal(Inform), Viz(Donut Chart, Chart.js/Canvas), Justification(Show static profit composition after US tax).
        - Equity Split (Section 2): Goal(Inform/Interact), Viz(Donut Chart, Chart.js/Canvas), Interaction(Updates dynamically based on Equity Slider), Justification(Clearly display the variable equity split).
        - Dividend Flow (Section 3): Goal(Organize/Inform/Interact), Viz(HTML/CSS Flowchart + JS Text Update), Interaction(Text updates based on Equity & Dividend Sliders), Justification(Visually show the step-by-step dynamic cash flow).
        - Dividend Loss (Section 3): Goal(Compare/Inform/Interact), Viz(Donut Chart, Chart.js/Canvas), Interaction(Updates dynamically based on Equity & Dividend Sliders), Justification(Highlights the variable excess tax loss problem).
        - Tax Explainer (Gemini API): Goal(Inform/Clarify), Viz(Modal/Text), Interaction(Button click calls LLM API with Search Grounding), Justification(Enhances understanding of complex cross-border tax terms).
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <title>美國子公司稅務模擬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        .kpi-card {
            @apply bg-white p-6 rounded-2xl shadow-lg transform transition-transform hover:scale-105;
        }
        .flow-step {
            @apply bg-white p-4 rounded-lg shadow-md text-center border-l-4;
        }
        .arrow {
            @apply text-4xl text-gray-400 my-4 text-center;
        }
        input[type=range]::-webkit-slider-thumb {
            @apply bg-blue-600;
        }
        input[type=range]::-moz-range-thumb {
            @apply bg-blue-600;
        }
    </style>
</head>
<body class="text-gray-800" onload="initCharts()">

    <!-- 導覽列 -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-2xl font-bold text-blue-800">互動稅務報告</h1>
                </div>
                <div class="hidden md:flex md:space-x-8">
                    <a href="#dashboard" class="text-gray-600 hover:text-blue-700 font-medium">情境儀表板</a>
                    <a href="#simulator" class="text-gray-600 hover:text-blue-700 font-medium">資金流動模擬</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- 主內容區 -->
    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <!-- Section 1: 情境儀表板 (含互動輸入) -->
        <section id="dashboard" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-4">假設情境：美國加州子公司已彌補累積虧損</h2>
            <p class="text-left text-lg text-gray-600 mb-8">本報告基於以下假設情境，已彌補累積虧損後，預估仍有稅前淨利 $200 萬美元，董事會決議分配股利＄100萬元，於匯回台灣過程中的稅務影響。</p>
            
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h3 class="text-2xl font-bold text-blue-700 mb-4 text-center">互動參數設定 (請拖動滑桿)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 參數 1: 預估稅前淨利金額 -->
                    <div>
                        <label for="profitSlider" class="block text-lg font-medium mb-2">
                            預估稅前淨利 (USD)：<span id="displayProfit" class="font-bold text-red-600">$2,000,000</span>
                        </label>
                        <input type="range" id="profitSlider" min="500000" max="5000000" value="2000000" step="100000" class="w-full h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateScenario()">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span>$0.5 M (最低)</span>
                            <span>$5.0 M (最高)</span>
                        </div>
                    </div>

                    <!-- 參數 2: 分配股利金額 -->
                    <div>
                        <label for="dividendSlider" class="block text-lg font-medium mb-2">
                            總分配股利金額 (USD)：<span id="displayDividend" class="font-bold text-red-600">$1,000,000</span>
                        </label>
                        <input type="range" id="dividendSlider" min="100000" max="1440328" value="1000000" step="50000" class="w-full h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateScenario()">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span>$100k (最低)</span>
                            <span id="maxDivLabel">$1,440k (最高可分配淨利)</span>
                        </div>
                    </div>
                    <!-- 參數 3: 母公司股權比例 -->
                    <div>
                        <label for="equitySlider" class="block text-lg font-medium mb-2">
                            台灣母公司股權比例：<span id="displayEquity" class="font-bold text-red-600">88%</span>
                        </label>
                        <input type="range" id="equitySlider" min="50" max="100" value="88" step="1" class="w-full h-3 bg-gray-300 rounded-lg appearance-none cursor-pointer" oninput="updateScenario()">
                        <div class="flex justify-between text-sm text-gray-600 mt-1">
                            <span>50% (最低)</span>
                            <span>100% (最高)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
                <div class="kpi-card border-l-4 border-blue-500">
                    <div class="text-5xl font-extrabold text-blue-700" id="kpiProfit">$2.0 M</div>
                    <div class="text-lg font-medium text-gray-700 mt-2">預估稅前淨利</div>
                    <p class="text-sm text-gray-500">(已彌補累積虧損)</p>
                </div>
                <div class="kpi-card border-l-4 border-gray-500">
                    <div class="text-5xl font-extrabold text-gray-800" id="kpiDividend">$1.0 M</div>
                    <div class="text-lg font-medium text-gray-700 mt-2">總分配股利</div>
                    <p class="text-sm text-gray-500">($1.44M 稅後淨利內)</p>
                </div>
                <div class="kpi-card border-l-4 border-red-500">
                    <div class="text-5xl font-extrabold text-red-600">30%</div>
                    <div class="text-lg font-medium text-gray-700 mt-2">股利預扣稅率</div>
                    <p class="text-sm text-gray-500">(因台美無租稅協定)
                        <button class="ml-1 text-xs text-blue-500 hover:text-blue-700 font-semibold" onclick="openExplainerModal('股利預扣稅率 (WHT)', '請用中文解釋一下美國的股利預扣稅率 (WHT) 是什麼？')">
                            ✨ 說明
                        </button>
                    </p>
                </div>
                <div class="kpi-card border-l-4 border-yellow-500">
                    <div class="text-5xl font-extrabold text-yellow-700" id="kpiEquity">88%</div>
                    <div class="text-lg font-medium text-gray-700 mt-2">台灣母公司持股</div>
                    <p class="text-sm text-gray-500">(其他為美國個人股東)</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6">股權比例佔比圖</h3>
                    <p class="text-center text-gray-600 mb-6">母公司與美國個人股東的持股比例結構。</p>
                    <div class="chart-container" style="max-width: 400px; height: 300px;">
                        <canvas id="equitySplitChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-2xl font-bold text-center mb-6">美國公司所得稅 (假設獲利 <span id="corpTaxProfitLabel">$2.0 M</span>)</h3>
                    <p class="text-left text-gray-600 mb-6">在分配股利前，公司獲利首先需繳納聯邦與加州企業稅，剩下的淨利可供分配。</p>
                    <div class="chart-container" style="max-width: 400px; height: 300px;">
                        <canvas id="corporateTaxChart"></canvas>
                    </div>
                    
                    <!-- 新增的稅額計算明細表格 -->
                    <h4 class="text-lg font-bold text-gray-700 mt-6 mb-3 border-t pt-3">稅額計算明細</h4>
                    <table class="w-full text-sm text-left text-gray-700 border-collapse">
                        <thead class="text-xs text-gray-900 uppercase bg-gray-50 border-b">
                            <tr>
                                <th scope="col" class="py-2 px-3">稅種</th>
                                <th scope="col" class="py-2 px-3">稅率</th>
                                <th scope="col" class="py-2 px-3">稅基 (USD)</th>
                                <th scope="col" class="py-2 px-3 text-right">稅額 (USD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b">
                                <td class="py-2 px-3">加州州稅 (State Tax)</td>
                                <td class="py-2 px-3">8.84%</td>
                                <td class="py-2 px-3" id="taxBaseCA">$2,000,000</td>
                                <td class="py-2 px-3 font-bold text-right text-red-600" id="taxAmountCA">$(176,800)</td>
                            </tr>
                            <tr class="bg-gray-50 border-b">
                                <td class="py-2 px-3">聯邦企業稅 (Federal Tax)</td>
                                <td class="py-2 px-3">21.00%</td>
                                <td class="py-2 px-3" id="taxBaseFED">$1,823,200</td>
                                <td class="py-2 px-3 font-bold text-right text-red-600" id="taxAmountFED">$(382,872)</td>
                            </tr>
                            <tr class="bg-blue-50/50">
                                <td class="py-2 px-3 font-extrabold text-blue-800">稅後淨利</td>
                                <td class="py-2 px-3">-</td>
                                <td class="py-2 px-3">-</td>
                                <td class="py-2 px-3 font-extrabold text-right text-blue-700" id="profitAfterTax">$1,440,328</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Section 2: 資金流動模擬 (固定為股利分配) -->
        <section id="simulator" class="mb-12 bg-gray-50 p-6 md:p-10 rounded-2xl shadow-inner">
            <h2 class="text-3xl font-bold text-center mb-8">資金流動模擬</h2>
            
            <div class="flex justify-center mb-8">
                <div class="relative bg-gray-200 rounded-full p-1 flex">
                    <button id="btnDividend" class="w-64 py-2 px-4 rounded-full font-bold z-10 bg-white shadow text-blue-700" disabled>股利分配路徑</button>
                </div>
            </div>

            <!-- 模擬 A: 股利分配路徑 -->
            <div id="dividendAnalysisSection">
                <h3 class="text-2xl font-bold text-center text-red-700 mb-6">模擬：純股利分配路徑 (問題分析)</h3>
                <p class="text-left text-lg text-gray-600 mb-8">此路徑顯示將持股比例分得之 <span id="dynDivAmount1" class="font-bold text-red-600"></span> 美元全數作為「股利」匯回時，因 30% 預扣稅導致的「超額稅款流失」。</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <!-- 流程圖 -->
                    <div>
                        <h4 class="text-xl font-bold mb-4 text-center">資金流動圖</h4>
                        <div class="flow-step border-blue-500">
                            <div class="text-lg font-bold">1. 分配 <span id="dynDivAmount2"></span> 股利</div>
                            <div class="text-sm text-gray-600">自美國子公司匯出 (佔總分配股利 <span id="dynTotalDivPct"></span>)</div>
                        </div>
                        <div class="arrow">⬇</div>
                        <div class="flow-step border-red-500">
                            <div class="text-lg font-bold">2. 美國扣繳30%(WHT)</div>
                            <div class="text-xl font-bold text-red-600" id="dynWHT"></div>
                        </div>
                         <div class="arrow">⬇</div>
                         <div class="flow-step border-yellow-500">
                            <div class="text-lg font-bold">3. 台灣應納營所稅 (20%)</div>
                            <div class="text-xl font-bold text-yellow-700" id="dynTWTaxDue_Step"></div>
                            <div class="text-sm text-gray-600">以扣繳前股利總額計算</div>
                            <div class="text-xs text-gray-700 mt-1">(此稅額可全額抵減美國已繳稅款，避免重複課稅)</div>
                        </div>
                         <div class="arrow">⬇</div>
                        <div class="flow-step border-green-500">
                            <div class="text-lg font-bold">4. 台灣母公司實收 (現金)</div>
                            <div class="text-xl font-bold text-green-700" id="dynNetCash"></div>
                            <div class="text-sm text-gray-600">已扣除所有稅務並完成抵減</div>
                        </div>
                         <div class="arrow" style="visibility: hidden;">⬇</div>
                        <!-- 步驟 5 刪除 -->
                    </div>
                    <!-- 圖表 -->
                    <div>
                        <h4 class="text-xl font-bold mb-4 text-center">股利最終分配圖</h4>
                        <div class="chart-container">
                            <canvas id="dividendLossChart"></canvas>
                        </div>
                        <p class="text-left text-gray-600 mt-4">圖示將股利總額分為最終台灣母公司實收淨現金、美國扣繳30%預扣款二部分。</p>
                    </div>
                </div>
                
                <!-- 新增：台灣稅務影響明細表 -->
                <div class="mt-10 p-6 bg-white rounded-2xl shadow-lg">
                    <h4 class="text-lg font-bold text-gray-700 mb-3 border-b pb-2">台灣稅務影響明細 (基於母公司分配之股利)</h4>
                    <table class="w-full text-sm text-left text-gray-700 border-collapse">
                        <thead class="text-xs text-gray-900 uppercase bg-gray-50 border-b">
                            <tr>
                                <th scope="col" class="py-2 px-3">步驟</th>
                                <th scope="col" class="py-2 px-3">項目</th>
                                <th scope="col" class="py-2 px-3">稅率/門檻</th>
                                <th scope="col" class="py-2 px-3 text-right">金額 (USD)</th>
                                <th scope="col" class="py-2 px-3">結論/備註</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b">
                                <td class="py-2 px-3">1.</td>
                                <td class="py-2 px-3">美國股利扣繳稅 (WHT)</td>
                                <td class="py-2 px-3">30% (無租稅協定)</td>
                                <td class="py-2 px-3 text-right text-red-600" id="detailWHT">$(240,000)</td>
                                <td class="py-2 px-3" id="remarkWHT">資金匯回前被預扣。</td>
                            </tr>
                            <tr class="bg-gray-50 border-b">
                                <td class="py-2 px-3">2.</td>
                                <td class="py-2 px-3">台灣應納營所稅</td>
                                <td class="py-2 px-3">20%</td>
                                <td class="py-2 px-3 text-right text-green-700" id="detailTWTax">$160,000</td>
                                <td class="py-2 px-3" id="remarkTWTax">台灣應繳稅額 (以股利總額計)。</td>
                            </tr>
                            <tr class="bg-white border-b">
                                <td class="py-2 px-3">3.</td>
                                <td class="py-2 px-3">國外已納稅額抵減 (FTC)</td>
                                <td class="py-2 px-3">20% (台灣上限)</td>
                                <td class="py-2 px-3 text-right text-blue-700" id="detailFTC">$(160,000)</td>
                                <td class="py-2 px-3" id="remarkFTC">美國已繳 $(240,000)，台灣最多讓抵 $(160,000)。</td>
                            </tr>
                            <tr class="bg-yellow-50/50">
                                <td class="py-2 px-3 font-extrabold">最終稅務結果</td>
                                <td class="py-2 px-3 font-extrabold">台灣補稅金額</td>
                                <td class="py-2 px-3">-</td>
                                <td class="py-2 px-3 font-extrabold text-right text-gray-700" id="detailFinalTax">$0</td>
                                <td class="py-2 px-3" id="remarkFinalTax">無需補稅，但產生超額稅款。</td>
                            </tr>
                            <tr class="bg-red-50/50">
                                <td class="py-2 px-3 font-extrabold text-red-700">實質稅款流失</td>
                                <td class="py-2 px-3 font-extrabold text-red-700">超額稅款</td>
                                <td class="py-2 px-3 font-extrabold text-red-700">10% 價差</td>
                                <td class="py-2 px-3 font-extrabold text-right text-red-700" id="detailExcessLoss">$(80,000)</td>
                                <td class="py-2 px-3" id="remarkExcessLoss">此部分 $(80,000) 無法退還，為集團淨損失。</td>
                            </tr>
                            <tr class="bg-green-50/50">
                                <td class="py-2 px-3 font-extrabold text-green-700">台灣母公司實收淨額</td>
                                <td class="py-2 px-3 font-extrabold text-green-700" id="detailBaseAmount"></td>
                                <td class="py-2 px-3">-</td>
                                <td class="py-2 px-3 font-extrabold text-right text-green-700" id="detailNetCashFinal">$560,000</td>
                                <td class="py-2 px-3" id="remarkNetCashFinal">扣繳前 $800,000，實拿 $560,000。</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
            
        </section>
        
    </main>
    
    <!-- Tax Explainer Modal -->
    <div id="explainerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 m-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="explainerTitle" class="text-xl font-bold text-blue-800">概念解析</h3>
                <button onclick="closeExplainerModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            <div id="explainerContent" class="text-gray-700 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-500">
                    <div class="text-lg">點擊 ✨ 說明 按鈕以啟動 AI 解釋。</div>
                </div>
            </div>
            <div id="explainerSources" class="text-xs text-gray-500 mt-4 border-t pt-2 hidden">
                資料來源：<span id="sourceList"></span>
            </div>
        </div>
    </div>

    <footer class="text-center p-8 text-gray-500 text-sm">
        <p>本互動報告僅供內部評估使用，不構成正式稅務或法律建議。所有數字均為估算值。</p>
    </footer>

    <script>
        // 註冊 Chart.js 插件
        if (window.Chart && window.ChartDataLabels) {
            Chart.register(ChartDataLabels);
        }

        let corporateTaxChart, dividendLossChart, equitySplitChart;
        
        // --- Chart Configs (Moved to Top) ---
        const chartTooltipCallback = {
            title: function(tooltipItems) {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                }
                return label;
            }
        };

        const datalabelsConfig = {
            formatter: (value, context) => {
                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = (value * 100 / total).toFixed(1);
                
                const isEquityChart = context.chart.canvas.id === 'equitySplitChart';
                
                let formattedValue;
                if (isEquityChart) {
                    // 股權圖只顯示百分比 (不顯示標籤，因為標籤已在圖例)
                    return percentage + '%'; 
                } else {
                    // 稅務圖顯示金額和百分比
                    formattedValue = '$' + Math.round(value).toLocaleString();
                    if (value > 0) {
                        return [formattedValue, percentage + '%'];
                    }
                }
                return '';
            },
            color: '#000000',
            textShadowColor: 'rgba(255, 255, 255, 0.7)',
            textShadowBlur: 4,
            font: {
                weight: 'bold',
                size: 14
            }
        };
        
        // --- Tax Calculation Constants ---
        const CA_RATE = 0.0884; 
        const FED_RATE = 0.21;
        const WHT_RATE = 0.30;
        const TW_RATE = 0.20;

        // --- Interactive Scenario Parameters ---
        const PROFIT_BEFORE_TAX_DEFAULT = 2000000;
        let currentProfitBeforeTax = PROFIT_BEFORE_TAX_DEFAULT; 
        let currentDividend = 1000000;
        let currentEquity = 0.88; 
        
        let usTaxResults; // Stores dynamic US tax calculations

        // --- Helper Functions ---
        
        function calculateUSCorpTax(profitBeforeTax) {
            const usCorpTaxCA = profitBeforeTax * CA_RATE;
            const fedTaxBase = profitBeforeTax - usCorpTaxCA;
            const usCorpTaxFed = fedTaxBase * FED_RATE;
            const usCorpTaxTotal = usCorpTaxCA + usCorpTaxFed;
            const profitAfterTax = profitBeforeTax - usCorpTaxTotal;

            return { usCorpTaxCA, usCorpTaxFed, usCorpTaxTotal, profitAfterTax, fedTaxBase };
        }
        
        function formatCurrency(amount) {
            return `$${Math.round(amount).toLocaleString()}`;
        }
        
        function formatSliderLabel(amount) {
            return `$${Math.round(amount).toLocaleString()}`;
        }
        
        function formatMillion(amount) {
             // 格式化為 Million 單位 (M)
            const millionAmount = amount / 1000000;
            return `$${millionAmount.toFixed(0)} M`;
        }

        function calculateDividendScenario(totalDividend, equityShare, usCorpTaxTotal) {
            const motherDivPreWHT = totalDividend * equityShare;
            const wht = motherDivPreWHT * WHT_RATE;
            const twTaxDue = motherDivPreWHT * TW_RATE; 
            const ftcCap = twTaxDue; // 台灣抵稅上限為應納稅額
            const netCash = motherDivPreWHT - wht;
            const excessLoss = Math.max(0, wht - ftcCap);
            const totalTax = usCorpTaxTotal + wht;
            const finalNetProfit = netCash;

            return { motherDivPreWHT, wht, netCash, twTaxDue, ftcCap, excessLoss, totalTax, finalNetProfit };
        }

        // --- UI Update and Scenario Logic ---
        
        function updateScenario() {
            const profitSlider = document.getElementById('profitSlider');
            const dividendSlider = document.getElementById('dividendSlider');
            const equitySlider = document.getElementById('equitySlider');
            
            if (!profitSlider || !dividendSlider || !equitySlider) return; 

            // 1. 更新並計算預估淨利
            currentProfitBeforeTax = parseFloat(profitSlider.value);
            usTaxResults = calculateUSCorpTax(currentProfitBeforeTax);

            // 更新 KPI 和滑桿顯示
            document.getElementById('displayProfit') && (document.getElementById('displayProfit').innerText = formatCurrency(currentProfitBeforeTax));
            document.getElementById('kpiProfit') && (document.getElementById('kpiProfit').innerText = formatMillion(currentProfitBeforeTax));
            document.getElementById('corpTaxProfitLabel') && (document.getElementById('corpTaxProfitLabel').innerText = formatMillion(currentProfitBeforeTax));


            // 2. 更新股利滑桿限制和值 (確保不超過稅後淨利)
            const newMaxDiv = Math.floor(usTaxResults.profitAfterTax);
            dividendSlider.max = newMaxDiv;
            
            if (currentDividend > newMaxDiv) {
                currentDividend = newMaxDiv;
                dividendSlider.value = newMaxDiv;
            }
            
            currentDividend = parseFloat(dividendSlider.value);
            
            // 更新股利滑桿標籤
            document.getElementById('maxDivLabel') && (document.getElementById('maxDivLabel').innerText = formatMillion(newMaxDiv));
            document.getElementById('displayDividend') && (document.getElementById('displayDividend').innerText = formatCurrency(currentDividend));
            document.getElementById('kpiDividend') && (document.getElementById('kpiDividend').innerText = formatMillion(currentDividend));


            // 3. 更新股權比例
            currentEquity = parseFloat(equitySlider.value) / 100;
            document.getElementById('displayEquity') && (document.getElementById('displayEquity').innerText = `${Math.round(currentEquity * 100)}%`);
            document.getElementById('kpiEquity') && (document.getElementById('kpiEquity').innerText = `${Math.round(currentEquity * 100)}%`);
            
            // 4. 執行模擬計算
            updateSimulation();
        }

        function updateSimulation() {
            const currentDivScenario = calculateDividendScenario(currentDividend, currentEquity, usTaxResults.usCorpTaxTotal);
            
            // 計算合併後的美國扣繳款 (WHT)
            const totalUSWHT = currentDivScenario.wht;
            const motherDivPreWHT = currentDivScenario.motherDivPreWHT;

            // 1. 更新股權圓餅圖
            if (equitySplitChart) {
                equitySplitChart.data.datasets[0].data = [currentEquity * 100, (1 - currentEquity) * 100];
                equitySplitChart.data.labels = [`台灣母公司 (${Math.round(currentEquity * 100)}%)`, `美國個人股東 (${Math.round((1 - currentEquity) * 100)}%)`];
                equitySplitChart.update();
            }
            
            // 2. 更新美國公司所得稅圓餅圖 (Corporate Tax Chart)
            if (corporateTaxChart) {
                const profitAfterTax = usTaxResults.profitAfterTax;
                const usCorpTaxFed = usTaxResults.usCorpTaxFed;
                const usCorpTaxCA = usTaxResults.usCorpTaxCA;

                corporateTaxChart.data.datasets[0].data = [profitAfterTax, usCorpTaxFed, usCorpTaxCA];
                corporateTaxChart.data.labels = [
                    '稅後淨利 (可分配)', 
                    `聯邦企業稅 (21% on Tax Base)`, 
                    `加州州稅 (8.84%)`
                ];
                corporateTaxChart.update();
            }

            // 3. 更新美國公司所得稅計算表格
            const profitBeforeTax = currentProfitBeforeTax;
            const fedTaxBase = usTaxResults.fedTaxBase;
            
            const taxBaseCAElement = document.getElementById('taxBaseCA');
            const taxAmountCAElement = document.getElementById('taxAmountCA');
            const taxBaseFEDElement = document.getElementById('taxBaseFED');
            const taxAmountFEDElement = document.getElementById('taxAmountFED');
            const profitAfterTaxElement = document.getElementById('profitAfterTax');

            if (taxBaseCAElement) taxBaseCAElement.innerText = formatCurrency(profitBeforeTax);
            if (taxAmountCAElement) taxAmountCAElement.innerText = `(${formatCurrency(usTaxResults.usCorpTaxCA).slice(1)})`;
            
            if (taxBaseFEDElement) taxBaseFEDElement.innerText = formatCurrency(fedTaxBase);
            if (taxAmountFEDElement) taxAmountFEDElement.innerText = `(${formatCurrency(usTaxResults.usCorpTaxFed).slice(1)})`;
            
            if (profitAfterTaxElement) profitAfterTaxElement.innerText = formatCurrency(usTaxResults.profitAfterTax);


            // 4. 更新股利分配流程 (模擬一)
            document.getElementById('dynDivAmount1') && (document.getElementById('dynDivAmount1').innerText = formatCurrency(motherDivPreWHT));
            document.getElementById('dynDivAmount2') && (document.getElementById('dynDivAmount2').innerText = formatCurrency(motherDivPreWHT));
            document.getElementById('dynTotalDivPct') && (document.getElementById('dynTotalDivPct').innerText = `${Math.round(currentEquity * 100)}%`);
            document.getElementById('dynWHT') && (document.getElementById('dynWHT').innerText = `-${formatCurrency(currentDivScenario.wht)}`);
            document.getElementById('dynNetCash') && (document.getElementById('dynNetCash').innerText = formatCurrency(currentDivScenario.netCash));
            
            // 台灣應納稅額步驟
            document.getElementById('dynTWTaxDue_Step') && (document.getElementById('dynTWTaxDue_Step').innerText = formatCurrency(currentDivScenario.twTaxDue));
            
            
            // 5. 更新台灣稅務影響明細表 (Conclusion/Remark Column)
            const detailWHTElement = document.getElementById('detailWHT');
            const detailTWTaxElement = document.getElementById('detailTWTax');
            const detailFTCElement = document.getElementById('detailFTC');
            const detailFinalTaxElement = document.getElementById('detailFinalTax');
            const detailExcessLossElement = document.getElementById('detailExcessLoss');
            const detailBaseAmountElement = document.getElementById('detailBaseAmount');
            const detailNetCashFinalElement = document.getElementById('detailNetCashFinal');

            if (detailWHTElement) detailWHTElement.innerText = `(${formatCurrency(currentDivScenario.wht).slice(1)})`;
            if (detailTWTaxElement) detailTWTaxElement.innerText = formatCurrency(currentDivScenario.twTaxDue);
            if (detailFTCElement) detailFTCElement.innerText = `(${formatCurrency(currentDivScenario.ftcCap).slice(1)})`;
            if (detailFinalTaxElement) detailFinalTaxElement.innerText = (currentDivScenario.twTaxDue - currentDivScenario.ftcCap) > 0 ? formatCurrency(currentDivScenario.twTaxDue - currentDivScenario.ftcCap) : '$0';
            if (detailExcessLossElement) detailExcessLossElement.innerText = `(${formatCurrency(currentDivScenario.excessLoss).slice(1)})`;
            
            if (detailBaseAmountElement) detailBaseAmountElement.innerText = `${formatCurrency(motherDivPreWHT).slice(1)} - ${formatCurrency(currentDivScenario.wht).slice(1)}`;
            if (detailNetCashFinalElement) detailNetCashFinalElement.innerText = formatCurrency(currentDivScenario.netCash);
            
            // 更新備註欄位的金額 (Conclusion/Remark Column Updates)
            document.getElementById('remarkWHT') && (document.getElementById('remarkWHT').innerText = `資金匯回前被預扣。`);
            document.getElementById('remarkTWTax') && (document.getElementById('remarkTWTax').innerText = `台灣應繳稅額 (以股利總額計)。`);
            document.getElementById('remarkFTC') && (document.getElementById('remarkFTC').innerText = `美國已繳 ${formatCurrency(currentDivScenario.wht).slice(1)}，台灣最多讓抵 ${formatCurrency(currentDivScenario.ftcCap).slice(1)}。`);
            document.getElementById('remarkFinalTax') && (document.getElementById('remarkFinalTax').innerText = currentDivScenario.twTaxDue > 0 ? `無需補稅，但產生超額稅款。` : `無需補稅。`);
            document.getElementById('remarkExcessLoss') && (document.getElementById('remarkExcessLoss').innerText = `此部分 ${formatCurrency(currentDivScenario.excessLoss).slice(1)} 無法退還，為集團淨損失。`);
            document.getElementById('remarkNetCashFinal') && (document.getElementById('remarkNetCashFinal').innerText = `扣繳前 ${formatCurrency(motherDivPreWHT).slice(1)}，實拿 ${formatCurrency(currentDivScenario.netCash).slice(1)}。`);


            // 6. 更新股利損失圓餅圖 (模擬一)
            if (dividendLossChart) {
                dividendLossChart.data.datasets[0].data = [
                    currentDivScenario.netCash, 
                    totalUSWHT 
                ];
                dividendLossChart.data.labels = ['台灣母公司實收 (現金)', '美國扣繳 30% 預扣款'];
                dividendLossChart.data.datasets[0].backgroundColor = ['#10b981', '#ef4444']; 
                dividendLossChart.update();
            }
        }

        function initCharts() {
            // Chart 1: Equity Split
            const ctxEquity = document.getElementById('equitySplitChart').getContext('2d');
            equitySplitChart = new Chart(ctxEquity, {
                type: 'doughnut',
                data: {
                    labels: ['台灣母公司 (88%)', '美國個人股東 (12%)'],
                    datasets: [{
                        data: [88, 12],
                        backgroundColor: ['#06b6d4', '#f59e0b'],
                        borderColor: '#f8f9fa',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: chartTooltipCallback },
                        datalabels: datalabelsConfig
                    }
                }
            });

            // Chart 2: Corporate Tax (Static base, but values are dynamic)
            const ctxCorp = document.getElementById('corporateTaxChart').getContext('2d');
            corporateTaxChart = new Chart(ctxCorp, {
                type: 'doughnut',
                data: {
                    labels: ['稅後淨利 (可分配)', '聯邦企業稅 (21% on Tax Base)', '加州州稅 (8.84%)'],
                    datasets: [{
                        data: [0, 0, 0], // Initialized with zero
                        backgroundColor: ['#06b6d4', '#f59e0b', '#ef4444'],
                        borderColor: '#f8f9fa',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: chartTooltipCallback },
                        datalabels: datalabelsConfig
                    }
                }
            });

            // Chart 3: Dividend Loss (Dynamic)
            const ctxDivLoss = document.getElementById('dividendLossChart').getContext('2d');
            dividendLossChart = new Chart(ctxDivLoss, {
                type: 'doughnut',
                data: {
                    labels: ['台灣母公司實收 (現金)', '美國扣繳 30% 預扣款'], // 預設標籤
                    datasets: [{
                        data: [0, 0], // Initialized with zero
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: '#ffffff',
                        borderWidth: 4,
                    }]
                },
                 options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: chartTooltipCallback },
                        datalabels: datalabelsConfig
                    }
                }
            });
            
            // Run initial scenario after charts are initialized
            usTaxResults = calculateUSCorpTax(PROFIT_BEFORE_TAX_DEFAULT);
            updateScenario();
        }

        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        function openExplainerModal(title, query) {
            document.getElementById('explainerTitle').innerText = title;
            document.getElementById('explainerModal').classList.remove('hidden');
            explainConcept(query);
        }

        function closeExplainerModal() {
            document.getElementById('explainerModal').classList.add('hidden');
            document.getElementById('explainerSources').classList.add('hidden');
        }
        
        async function explainConcept(userQuery) {
            const contentDiv = document.getElementById('explainerContent');
            const sourcesDiv = document.getElementById('explainerSources');
            const sourceListSpan = document.getElementById('sourceList');

            contentDiv.innerHTML = '<div class="text-center text-blue-600"><p class="animate-pulse">AI 顧問正在查詢資料，請稍候...</p><p>✨</p></div>';
            sourcesDiv.classList.add('hidden');
            sourceListSpan.innerHTML = '';
            
            const systemPrompt = "你是一位國際稅務顧問。請用繁體中文，針對使用者提出的稅務名詞，提供一個精簡、專業且易懂的解釋。內容必須與台灣和美國的跨境稅務情境相關。";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn("API rate limit exceeded, retrying...");
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }

                        contentDiv.innerHTML = text.replace(/\n/g, '<br><br>');

                        if (sources.length > 0) {
                            sourceListSpan.innerHTML = sources.map((s, index) => 
                                `<a href="${s.uri}" target="_blank" class="text-blue-500 hover:text-blue-700">${s.title}</a>`
                            ).join(' | ');
                            sourcesDiv.classList.remove('hidden');
                        }
                        return;
                    } else {
                        contentDiv.innerHTML = '<p class="text-red-600">抱歉，AI 服務未能提供有效的解釋內容。</p>';
                        return;
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (i === maxRetries - 1) {
                         contentDiv.innerHTML = '<p class="text-red-600">抱歉，AI 服務連線失敗或超時，請稍後再試。</p>';
                    }
                }
            }
        }
    </script>
</body>
</html>